#!/usr/bin/python
# -*- coding: utf-8 -*-
#UNAM-CERT
import os
import sys
import argparse
from scapy.all import *
import re


def Ops():
    """
    Las opciones incluyen -s con el cual
    indicamos un segmento o una ip
    """
    parser = argparse.ArgumentParser()
    parser.add_argument('-s','--seg',dest='seg',default=None,help='Indica ip "x.x.x.x" o segmento "x.x.x.x/x') 
    parser.add_argument('-p','--proto', dest='protocol', default=None, help='Indica el protocolo "x" lista "x,x,x" o rango "x-x".')
    args = parser.parse_args()
    return args

def ipG(b1=None,b2=None,b3=None,b4=None):
    """
    Devuelve un objeto con todas las IP's en un segmento
    especificado
    Argumentos:
        (str)[]
    Salida:
        Lista de IP's (str)[]
    
    """
    ars = locals()
    ip = ''
    for i in ars:
        if not ars[i]:
            ars[i]=range(256)
    for j in ars['b1']:
        for i in ars['b2']:
            for k in ars['b3']:
                for l in ars['b4']:
                    ip = '%s.%s.%s.%s'%(j,i,k,l)
                    yield ip



def Scan(ips,ports):
    for dst_ip in ips:
        for dst_port in ports:
            print "probando %s en puerto %s" % (dst_ip,dst_port)
            tcp_connect_scan_resp = sr1(IP(dst=dst_ip)/TCP(dport=int(dst_port),flags="S"),timeout=0.1,verbose=0)
            try:
                print tcp_connect_scan_resp.getlayer(TCP).flags
            except Exception as e:
                print "sin respuesta"

def Proto(segStr):
    """
    Obtiene el segmento en forma de lista
    """
    port = re.findall('(^\d{1,5}$)',segStr)
    ports = re.findall('^((\d{1,5}\,)+(\d{1,5}))$',segStr)
    rport = re.findall('^(\d{1,5}\-\d{1,5})$',segStr)
    if port:
        return port
    if ports:
        return list(ports[0])[0].split(',')
    if rport:
        return range(int(rport[0].split('-')[0]),int(rport[0].split('-')[1]))



def Seg(segStr):
    """
    Obtiene el segmento en forma de lista
    """
    m = 256
    addr = re.findall('^((\d{1,3}\.){3}\d{1,3})$',segStr)
    if addr:
        return [list(addr[0])[0]]
    seg = list(re.findall('((\d{1,3}\.){3}\d{1,3})\/(\d{1,2})',segStr)[0])
    p = int(int(seg[2])/8)
    for i in range(int(seg[2]) - p*8):
        m -= (1 << (7-i))
    ips = list(re.findall('(\d{1,3}\.)(\d{1,3}\.)(\d{1,3}\.)(\d{1,3})',seg[0])[0])
    i = 0
    while (i<4):
        if i > p - 1:
            ips[i] = None
        i = i + 1
    b1 = ips[0]
    if b1:
        b1 = ["%s"%b1[0:-1]]
    else:
        b1 = range(m)
        p = 0
    b2 = ips[1]
    if b2:
        b2 = ["%s"%b2[0:-1]]
    else:
        b2 = range(m)
        p = 0
    b3 = ips[2]
    if b3:
        b3 = ["%s"%b3[0:-1]]
    else:
        b3 = range(m)
        p = 0
    b4 = ips[3]
    if b4:
        b4 = ["%s"%b4[0:-1]]
    else:
        b4 = range(m)
    return ipG(b1,b2,b3,b4)


if __name__ == '__main__':
    """
    
    """
    ops = Ops()
    try:
        s = Seg(ops.seg)
        print s
        p = Proto(ops.protocol)
        print p
        Scan(s,p)
    except Exception as e:
        print e

